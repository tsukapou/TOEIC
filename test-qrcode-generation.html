<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 2rem;
        }
        .subtitle {
            color: #6b7280;
            margin-bottom: 32px;
            font-size: 1rem;
        }
        .section {
            margin-bottom: 32px;
            padding: 24px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }
        .section h2 {
            color: #374151;
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        .test-data-form {
            margin-bottom: 16px;
        }
        .test-data-form label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
        }
        .test-data-form input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.95rem;
            margin-bottom: 12px;
        }
        .test-data-form input:focus {
            outline: none;
            border-color: #667eea;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        .stat-card .label {
            color: #6b7280;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        .stat-card .value {
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 700;
        }
        .stat-card .value.success {
            color: #10b981;
        }
        .stat-card .value.warning {
            color: #f59e0b;
        }
        .stat-card .value.error {
            color: #ef4444;
        }
        #qrCodeCanvas {
            max-width: 100%;
            height: auto;
            border: 4px solid #e5e7eb;
            border-radius: 12px;
            margin-top: 20px;
            display: block;
        }
        .result-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #e5e7eb;
        }
        .result-box h3 {
            margin-top: 0;
            color: #374151;
        }
        .result-box pre {
            background: #1f2937;
            color: #10b981;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.85rem;
        }
        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            border-left: 4px solid #10b981;
        }
        .warning-message {
            background: #fef3c7;
            color: #92400e;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            border-left: 4px solid #f59e0b;
        }
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            border-left: 4px solid #ef4444;
        }
        .buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
        <p class="subtitle">ãƒ‡ãƒ¼ã‚¿å¼•ç¶™ãæ©Ÿèƒ½ã®QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™</p>
        
        <!-- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ -->
        <div class="section">
            <h2>ğŸ“ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ</h2>
            <div class="test-data-form">
                <label>ãƒ†ã‚¹ãƒˆå®Œäº†æ•°:</label>
                <input type="number" id="testCount" value="3" min="0" max="15">
                
                <label>é–“é•ãˆãŸå•é¡Œæ•°:</label>
                <input type="number" id="wrongCount" value="15" min="0" max="450">
                
                <label>å­¦ç¿’æ—¥æ•°:</label>
                <input type="number" id="studyDays" value="7" min="0" max="365">
            </div>
            <div class="buttons">
                <button onclick="createTestData()">ğŸ“¦ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
                <button onclick="clearTestData()">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
            </div>
            <div id="dataCreationResult"></div>
        </div>
        
        <!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ -->
        <div class="section">
            <h2>ğŸ“± QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</h2>
            <div class="buttons">
                <button onclick="generateQRCode()">ğŸš€ QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ</button>
                <button onclick="downloadQRCode()" id="downloadBtn" disabled>ğŸ’¾ QRã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜</button>
            </div>
            
            <div id="qrResult"></div>
            
            <canvas id="qrCodeCanvas" style="display: none;"></canvas>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºåˆ†æ -->
        <div class="section">
            <h2>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºåˆ†æ</h2>
            <button onclick="analyzeDataSize()">ğŸ” ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã‚’åˆ†æ</button>
            <div id="sizeAnalysisResult"></div>
        </div>
    </div>
    
    <script>
        // LocalStorageã‚­ãƒ¼å®šç¾©
        const STORAGE_KEYS = {
            progress: 'toeic_part5_progress',
            scores: 'toeic_part5_scores',
            wrongAnswers: 'toeic_wrong_answers',
            streakData: 'toeic_streak_data',
            dailyMissions: 'toeic_daily_missions',
            userProfile: 'toeic_user_profile'
        };
        
        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function createTestData() {
            try {
                const testCount = parseInt(document.getElementById('testCount').value);
                const wrongCount = parseInt(document.getElementById('wrongCount').value);
                const studyDays = parseInt(document.getElementById('studyDays').value);
                
                console.log('ğŸ“¦ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆé–‹å§‹...');
                
                // ãƒ†ã‚¹ãƒˆé€²æ—
                const progress = { tests: {} };
                for (let i = 1; i <= testCount; i++) {
                    progress.tests[i] = {
                        score: Math.floor(Math.random() * 10) + 20,
                        predictedScore: Math.floor(Math.random() * 200) + 400,
                        completed: true,
                        date: new Date(Date.now() - i * 86400000).toISOString()
                    };
                }
                localStorage.setItem(STORAGE_KEYS.progress, JSON.stringify(progress));
                
                // é–“é•ãˆãŸå•é¡Œ
                const wrongAnswers = [];
                for (let i = 0; i < wrongCount; i++) {
                    wrongAnswers.push({
                        questionId: i + 1,
                        category: ['æ–‡æ³•', 'èªå½™', 'ç†Ÿèª'][Math.floor(Math.random() * 3)],
                        mistakeCount: Math.floor(Math.random() * 3) + 1,
                        lastAttempt: new Date(Date.now() - Math.random() * 604800000).toISOString()
                    });
                }
                localStorage.setItem(STORAGE_KEYS.wrongAnswers, JSON.stringify(wrongAnswers));
                
                // å­¦ç¿’ã‚¹ãƒˆãƒªãƒ¼ã‚¯
                const studyHistory = [];
                for (let i = 0; i < studyDays; i++) {
                    const date = new Date(Date.now() - i * 86400000);
                    studyHistory.push(date.toISOString().split('T')[0]);
                }
                const streakData = {
                    currentStreak: Math.min(studyDays, 7),
                    longestStreak: studyDays,
                    totalStudyDays: studyDays,
                    studyHistory: studyHistory,
                    lastStudyDate: new Date().toISOString().split('T')[0]
                };
                localStorage.setItem(STORAGE_KEYS.streakData, JSON.stringify(streakData));
                
                // ãƒ‡ã‚¤ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³
                const dailyMissions = {
                    totalPoints: studyDays * 50,
                    history: [],
                    lastDate: new Date().toISOString().split('T')[0]
                };
                localStorage.setItem(STORAGE_KEYS.dailyMissions, JSON.stringify(dailyMissions));
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                const userProfile = {
                    nickname: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
                    targetScore: 800,
                    examDate: new Date(Date.now() + 90 * 86400000).toISOString()
                };
                localStorage.setItem(STORAGE_KEYS.userProfile, JSON.stringify(userProfile));
                
                document.getElementById('dataCreationResult').innerHTML = 
                    '<div class="success-message">' +
                    '<strong>âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†ï¼</strong><br>' +
                    `ãƒ†ã‚¹ãƒˆå®Œäº†: ${testCount}å›<br>` +
                    `é–“é•ãˆãŸå•é¡Œ: ${wrongCount}å•<br>` +
                    `å­¦ç¿’æ—¥æ•°: ${studyDays}æ—¥` +
                    '</div>';
                
                console.log('âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†');
                
            } catch (error) {
                console.error('âŒ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('dataCreationResult').innerHTML = 
                    `<div class="error-message">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearTestData() {
            if (confirm('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                document.getElementById('dataCreationResult').innerHTML = 
                    '<div class="success-message">ğŸ—‘ï¸ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ</div>';
                console.log('ğŸ—‘ï¸ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†');
            }
        }
        
        // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        async function generateQRCode() {
            try {
                console.log('ğŸ“± QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆé–‹å§‹...');
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                const exportData = {
                    version: '1.0.0',
                    exportDate: new Date().toISOString(),
                    exportTimestamp: Date.now(),
                    data: {}
                };
                
                Object.entries(STORAGE_KEYS).forEach(([key, storageKey]) => {
                    const value = localStorage.getItem(storageKey);
                    if (value) {
                        try {
                            exportData.data[storageKey] = JSON.parse(value);
                        } catch (e) {
                            exportData.data[storageKey] = value;
                        }
                    }
                });
                
                const jsonString = JSON.stringify(exportData);
                const originalSize = new Blob([jsonString]).size;
                
                console.log(`ğŸ“Š å…ƒãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ${originalSize} ãƒã‚¤ãƒˆ`);
                
                // LZ-String ã§åœ§ç¸®
                const compressed = LZString.compressToBase64(jsonString);
                const compressedSize = new Blob([compressed]).size;
                const compressionRate = ((1 - compressedSize / originalSize) * 100).toFixed(1);
                
                console.log(`ğŸ“Š åœ§ç¸®å¾Œã‚µã‚¤ã‚º: ${compressedSize} ãƒã‚¤ãƒˆ (${compressionRate}%å‰Šæ¸›)`);
                
                // QRã‚³ãƒ¼ãƒ‰å®¹é‡ãƒã‚§ãƒƒã‚¯
                const QR_MAX_SIZE = 2953;
                const isOverCapacity = compressedSize > QR_MAX_SIZE;
                
                // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                const canvas = document.getElementById('qrCodeCanvas');
                await QRCode.toCanvas(canvas, compressed, {
                    width: 400,
                    margin: 2,
                    errorCorrectionLevel: 'M'
                });
                
                canvas.style.display = 'block';
                document.getElementById('downloadBtn').disabled = false;
                
                // çµæœè¡¨ç¤º
                let resultHTML = '<div class="stats">';
                resultHTML += `
                    <div class="stat-card">
                        <div class="label">å…ƒãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º</div>
                        <div class="value">${(originalSize / 1024).toFixed(2)} KB</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">åœ§ç¸®å¾Œã‚µã‚¤ã‚º</div>
                        <div class="value ${isOverCapacity ? 'error' : 'success'}">${(compressedSize / 1024).toFixed(2)} KB</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">åœ§ç¸®ç‡</div>
                        <div class="value success">${compressionRate}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">QRå®¹é‡åˆ¶é™</div>
                        <div class="value">${(QR_MAX_SIZE / 1024).toFixed(2)} KB</div>
                    </div>
                `;
                resultHTML += '</div>';
                
                if (isOverCapacity) {
                    resultHTML += `
                        <div class="error-message">
                            <strong>âš ï¸ å®¹é‡ã‚ªãƒ¼ãƒãƒ¼</strong><br>
                            ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºãŒQRã‚³ãƒ¼ãƒ‰ã®å®¹é‡åˆ¶é™ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚<br>
                            è¶…é: ${((compressedSize - QR_MAX_SIZE) / 1024).toFixed(2)} KB<br>
                            <br>
                            <strong>è§£æ±ºç­–:</strong><br>
                            â€¢ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã‚’ä½¿ç”¨<br>
                            â€¢ JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨<br>
                            â€¢ åˆ†å‰²QRã‚³ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼ˆä»Šå¾Œå®Ÿè£…äºˆå®šï¼‰
                        </div>
                    `;
                } else {
                    resultHTML += `
                        <div class="success-message">
                            <strong>âœ… QRã‚³ãƒ¼ãƒ‰ç”ŸæˆæˆåŠŸï¼</strong><br>
                            ãƒ‡ãƒ¼ã‚¿ã¯QRã‚³ãƒ¼ãƒ‰ã®å®¹é‡å†…ã«åã¾ã£ã¦ã„ã¾ã™ã€‚<br>
                            ä½™è£•: ${((QR_MAX_SIZE - compressedSize) / 1024).toFixed(2)} KB
                        </div>
                    `;
                }
                
                document.getElementById('qrResult').innerHTML = resultHTML;
                
                console.log('âœ… QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†');
                
            } catch (error) {
                console.error('âŒ QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('qrResult').innerHTML = 
                    `<div class="error-message">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        // QRã‚³ãƒ¼ãƒ‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadQRCode() {
            try {
                const canvas = document.getElementById('qrCodeCanvas');
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '').replace('T', '_');
                    link.download = `toeic_qrcode_test_${timestamp}.png`;
                    link.href = url;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    alert('âœ… QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                });
            } catch (error) {
                console.error('âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºåˆ†æ
        function analyzeDataSize() {
            try {
                console.log('ğŸ” ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºåˆ†æé–‹å§‹...');
                
                let totalSize = 0;
                const breakdown = [];
                
                Object.entries(STORAGE_KEYS).forEach(([key, storageKey]) => {
                    const value = localStorage.getItem(storageKey);
                    if (value) {
                        const size = new Blob([value]).size;
                        totalSize += size;
                        breakdown.push({
                            name: key,
                            storageKey: storageKey,
                            size: size,
                            sizeKB: (size / 1024).toFixed(2),
                            percentage: 0 // å¾Œã§è¨ˆç®—
                        });
                    }
                });
                
                // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¨ˆç®—
                breakdown.forEach(item => {
                    item.percentage = ((item.size / totalSize) * 100).toFixed(1);
                });
                
                // ã‚½ãƒ¼ãƒˆï¼ˆã‚µã‚¤ã‚ºé™é †ï¼‰
                breakdown.sort((a, b) => b.size - a.size);
                
                // çµæœè¡¨ç¤º
                let resultHTML = '<div class="stats">';
                resultHTML += `
                    <div class="stat-card">
                        <div class="label">ç·ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º</div>
                        <div class="value">${(totalSize / 1024).toFixed(2)} KB</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">ãƒ‡ãƒ¼ã‚¿é …ç›®æ•°</div>
                        <div class="value">${breakdown.length}ä»¶</div>
                    </div>
                `;
                resultHTML += '</div>';
                
                resultHTML += '<div class="result-box">';
                resultHTML += '<h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿å†…è¨³</h3>';
                resultHTML += '<table style="width: 100%; border-collapse: collapse;">';
                resultHTML += '<thead><tr style="background: #f3f4f6; text-align: left;"><th style="padding: 8px;">é …ç›®</th><th>ã‚µã‚¤ã‚º</th><th>å‰²åˆ</th></tr></thead>';
                resultHTML += '<tbody>';
                
                breakdown.forEach(item => {
                    resultHTML += `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 8px;">${item.name}</td>
                            <td style="padding: 8px;">${item.sizeKB} KB</td>
                            <td style="padding: 8px;">${item.percentage}%</td>
                        </tr>
                    `;
                });
                
                resultHTML += '</tbody></table>';
                resultHTML += '</div>';
                
                document.getElementById('sizeAnalysisResult').innerHTML = resultHTML;
                
                console.log('âœ… ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºåˆ†æå®Œäº†');
                console.table(breakdown);
                
            } catch (error) {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºåˆ†æã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('sizeAnalysisResult').innerHTML = 
                    `<div class="error-message">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
